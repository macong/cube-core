/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 7 18:59
*/
KISSY.add("combobox/base",function(f,h,b,g,j,C,m){function d(a,e){var c=a.get("menu");if(c&&c.xclass)if(e)c=b.create(c,a),a.__set("menu",c);else return null;return c}function k(){var a=d(this);if(a&&a.get("visible"))if(this.get("multiple")&&this.get("alignWithCursor")){var e=t(this),c=e.tokens,a=this.get("menu"),i=e.cursorPosition,b=e.tokenIndex,e=this.get("input"),c=c.slice(0,b).join("").length;0<c&&++c;e.prop("selectionStart",c);e.prop("selectionEnd",c);c=e.prop("KsCursorOffset");e.prop("selectionStart",
i);e.prop("selectionEnd",i);a.set("xy",[c.left,c.top])}else a=this.get("menu"),i=f.clone(a.get("align")),i.node=this.get("el"),f.mix(i,z,!1),a.set("align",i)}function s(){var a=this;a._focusoutDismissTimer=setTimeout(function(){a.set("collapsed",!0)},30)}function o(){var a;if(a=this._focusoutDismissTimer)clearTimeout(a),this._focusoutDismissTimer=null}function p(a,e){var c=a.get("input");if(a.get("multiple")){var i=t(a),b=i.tokens,i=Math.max(0,i.tokenIndex),d=a.get("separator"),g=a.get("separatorType"),
f=b[i];b[i]=f&&-1!=d.indexOf(f.charAt(0))?f.charAt(0):"";b[i]+=e;f=b[i+1];if(g==r&&(!f||-1==d.indexOf(f.charAt(0))))b[i]+=d.charAt(0);i=b.slice(0,i+1).join("").length;c.val(b.join(""));c.prop("selectionStart",i);c.prop("selectionEnd",i)}else c.val(e)}function q(a){var e=a.get("input").val();if(a.get("multiple")){var c=t(a),e=c.tokens,c=c.tokenIndex,b=a.get("separator"),a=a.get("separatorType");return(e=e[c]||"")&&-1!=b.indexOf(e.charAt(0))?e.substring(1):a==r&&(0==c||-1==c)?e:m}return e}function A(){if(!this._stopNotify){var a=
q(this);a===m?this.set("collapsed",!0):(this._savedInputValue=a,this.sendRequest(a))}}function B(a){var e,c=[],b,g,l,j=d(this,1);j.removeChildren(!0);if(a&&a.length){a=a.slice(0,this.get("maxItemCount"));b=this.get("format")?this.get("format").call(this,q(this),a):[];for(l=0;l<a.length;l++)e=a[l],c.push(j.addChild(f.mix({xclass:"menuitem",content:e,textContent:e,value:e},b[l])));a=q(this);for(l=0;l<c.length;l++)if(c[l].get("textContent")==a){j.set("highlightedItem",c[l]);g=!0;break}if(!g&&this.get("autoHighlightFirst"))for(l=
0;l<c.length;l++)if(!c[l].get("disabled")){j.set("highlightedItem",c[l]);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}function u(){var a=this.get("input");this.get("collapsed")?(a[0].focus(),this.sendRequest("")):this.set("collapsed",!0)}function v(a){a.preventDefault()}function t(a){for(var e=a.get("input"),c=e.val(),b=[],d=[],f=a.get("literal"),g=a.get("separator"),j=!1,a=a.get("whitespace"),e=e.prop("selectionStart"),h=-1,k=0;k<c.length;k++){var m=c.charAt(k);k==e&&(h=b.length);
if(!j&&(!a&&/\s|\xa0/.test(m)&&(b.push(d.join("")),d=[]),-1!=g.indexOf(m)))b.push(d.join("")),d=[];f&&m==f&&(j=!j);d.push(m)}d.length&&b.push(d.join(""));-1==h&&(h=b.length-1);return{tokens:b,cursorPosition:e,tokenIndex:h}}var w,j=h.all,n=h.KeyCodes,z={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},x=j(f.Env.host),r="suffix",y=f.buffer(k,50);return w=b.Controller.extend({_savedInputValue:null,_stopNotify:0,bindUI:function(){this.get("input").on("valuechange",A,this)},bindMenu:function(){var a=
this,e,b;b=a.get("menu");b.on("click",function(b){b=b.target;a._stopNotify=1;a._selectItem(b);a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});x.on("resize",y,a);e=b.get("el");b=b.get("contentEl");e.on("focusout",s,a);e.on("focusin",o,a);b.on("mouseover",function(){a.get("input")[0].focus();o.call(a)});a.bindMenu=f.noop},_uiSetHasTrigger:function(a){var b=this.get("trigger");a?(b.on("click",u,this),b.on("mousedown",v)):(b.detach("click",u,this),b.detach("mousedown",v))},sendRequest:function(a){this.get("dataSource").fetchData(a,
B,this)},_uiSetCollapsed:function(a){if(a)(a=d(this))&&a.hide();else{var a=this.get("el"),b=d(this,1);o.call(this);b&&!b.get("visible")&&(b.render(),this.bindMenu(),this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),k.call(this),this.get("input").attr("aria-owns",b.get("el")[0].id))}},handleBlur:function(){w.superclass.handleBlur.apply(this,arguments);s.call(this)},handleKeyEventInternal:function(a){this.get("input");var b=d(this);if(b){var c=this.get("updateInputOnDownUp");c&&(this._stopNotify=
f.inArray(a.keyCode,[n.UP,n.DOWN,n.ESC])?1:0);var g;if(b.get("visible")){var j=b.handleKeydown(a);c&&f.inArray(a.keyCode,[n.DOWN,n.UP])&&p(this,b.get("activeItem").get("textContent"));if(a.keyCode==n.ESC)return this.set("collapsed",!0),c&&p(this,this._savedInputValue),!0;if(a.keyCode==n.TAB&&(g=b.get("activeItem")))if(g.performActionInternal(),this.get("multiple"))return!0;return j}if(a.keyCode==n.DOWN||a.keyCode==n.UP)return this.sendRequest(q(this)),!0}},_selectItem:function(a){if(a){var a=a.get("textContent"),
b=this.get("separatorType");p(this,a+(b==r?"":" "));this._savedInputValue=a}},destructor:function(){x.detach("resize",y,this)}},{ATTRS:{input:{view:1},trigger:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{xclass:"popupmenu"},setter:function(a){a instanceof b.Controller&&a.__set("parent",this)}},collapsed:{view:1},dataSource:{setter:function(a){return b.create(a)}},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},multiple:{},separator:{value:",;"},separatorType:{value:r},
whitespace:{valueFn:function(){return this.get("separatorType")==r}},updateInputOnDownUp:{value:!0},literal:{value:'"'},alignWithCursor:{},autoHighlightFirst:{},xrender:{value:g}}},{xclass:"combobox",priority:10})},{requires:["node","component","./baseRender","input-selection","menu"]});
KISSY.add("combobox/baseRender",function(f,h){return h.Render.extend({createDom:function(){var b,g;b=this.get("el");var j=this.get("trigger");this.get("srcNode")||(b.append('<div class="ks-combobox-input-wrap"></div>'),b=b.one(".ks-combobox-input-wrap"),g=this.get("input")||f.all('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="ks-combobox-input" />'),b.append(g),this.__set("input",g));j||this.__set("trigger",f.all('<div class="ks-combobox-trigger"><div class="ks-combobox-trigger-inner">&#x25BC;</div></div>'));
this.get("trigger").unselectable()},getKeyEventTarget:function(){return this.get("input")},_uiSetCollapsed:function(b){this.get("input").attr("aria-expanded",b)},_uiSetHasTrigger:function(b){var g=this.get("trigger");b?this.get("el").prepend(g):g.remove()}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},input:{},trigger:{}},HTML_PARSER:{input:function(b){return b.one(".ks-combobox-input")},trigger:function(b){return b.one(".ks-combobox-trigger")}}})},{requires:["component"]});
KISSY.add("combobox",function(f,h,b,g){h.LocalDataSource=b;h.RemoteDataSource=g;return h},{requires:["combobox/base","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/LocalDataSource",function(f,h){function b(){b.superclass.constructor.apply(this,arguments)}b.ATTRS={data:{value:[]},parse:{value:function(b,j){var h=[],m=0;if(!b)return j;f.each(j,function(d){-1!=d.indexOf(b)&&h.push(d);m++});return h}}};f.extend(b,f.Base,{fetchData:function(b,f,h){var m=this.get("parse"),d=this.get("data"),d=m(b,d);f.call(h,d)}});h.Manager.setConstructorByXClass("combobox-LocalDataSource",b);return b},{requires:["component"]});
KISSY.add("combobox/RemoteDataSource",function(f,h,b){function g(){g.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}g.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};f.extend(g,f.Base,{fetchData:function(b,f,g){var d=this,k,s=d.get("paramName"),o=d.get("parse"),p=d.get("cache"),q=d.get("allowEmpty");d.io&&(d.io.abort(),d.io=null);if(!b&&!0!==q)return f.call(g,[]);if(p&&(k=d.caches[b]))return f.call(g,k);k=d.get("xhrCfg");k.data=k.data||{};
k.data[s]=b;k.success=function(h){o&&(h=o(b,h));d.__set("data",h);p&&(d.caches[b]=h);f.call(g,h)};d.io=h(k)}});b.Manager.setConstructorByXClass("combobox-RemoteDataSource",g);return g},{requires:["ajax","component"]});
