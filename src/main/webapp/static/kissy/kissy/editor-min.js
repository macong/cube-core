/*
Copyright 2012, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 7 22:12
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(h,k,t){k=t.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:k.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(){return this._getData()},setter:function(h){return this._setData(h)}},formatData:{getter:function(){return this._getData(1)},setter:function(h){return this._setData(h)}},customStyle:{value:""},
customLink:{value:[]}}},{xclass:"editor"});k.HTML_PARSER={textarea:function(h){return h.one(".ks-editor-textarea")}};h.mix(k,h.EventTarget);return KISSY.Editor=k},{requires:["htmlparser","component","core"]});
KISSY.add("editor/core/clipboard",function(h,k,t,p){function r(a){this.editor=a;this._init()}function c(a){if(j.ie&&"BackCompat"!=a.get("document")[0].compatMode){var b=a.getSelection(),f;if(b.getType()==p.SELECTION_ELEMENT&&(f=b.getSelectedElement())){var g=b.getRanges()[0],e=d(a.get("document")[0].createTextNode(""));e.insertBefore(f);g.setStartBefore(e);g.setEndAfter(f);b.selectRanges([g]);setTimeout(function(){f.parent()&&(e.remove(),b.selectElement(f))},0)}}}var d=h.all,j=h.UA,n=k.RANGE,m=h.Event;
h.augment(r,{_init:function(){var a=this.editor,d=a.get("document")[0].body;m.on(d,j.ie?"beforepaste":"paste",this._paste,this);m.on(d,"contextmenu",function(){b=1;setTimeout(function(){b=0},10)});a.addCommand("copy",new q("copy"));a.addCommand("cut",new q("cut"));a.addCommand("paste",new q("paste"))},_paste:function(){if(!b){var a=this.editor,w=a.get("document")[0];if(!w.getElementById("ke_pastebin")){var f=a.getSelection(),g=new t(w),e=d(j.webkit?"<body></body>":"<div></div>",null,w);e.attr("id",
"ke_pastebin");j.webkit&&e[0].appendChild(w.createTextNode("\u00a0"));w.body.appendChild(e[0]);e.css({position:"absolute",top:f.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});e.css("left","-1000px");var l=f.createBookmarks();g.setStartAt(e,n.POSITION_AFTER_START);g.setEndAt(e,n.POSITION_BEFORE_END);g.select(!0);setTimeout(function(){var g;e=j.webkit&&(g=e.first())&&g.hasClass("Apple-style-span")?g:e;f.selectBookmarks(l);e.remove();var b=e.html();if(b=h.trim(b.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,
"")))g=a.fire("paste",{html:b,holder:e}),void 0!==g&&(b=g),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(b)?h.use("editor/core/dynamic/wordFilter",function(e,g){a.insertHtml(g.toDataFormat(b,a))}):a.insertHtml(b)},0)}}}});var u=function(a,b){var f=a.get("document")[0],g=d(f.body),e=!1,l=function(){e=!0};g.on(b,l);(7<j.ie?f:f.selection.createRange()).execCommand(b);g.detach(b,l);return e},o=j.ie?function(a,b){return u(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(f){return!1}},
x={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},q=function(a){this.type=a};q.prototype={exec:function(a){"cut"==this.type&&c(a);(a=o(a,this.type))||alert(x[this.type]);return a}};var a={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"},b;return{init:function(b){b.docReady(function(){new r(b)});var d={copy:1,cut:1,paste:1};b.on("contextmenu",function(f){f=f.contextmenu;if(!f.__copy_fix){f.__copy_fix=
1;for(var g in d)d.hasOwnProperty(g)&&f.addChild({xclass:"menuitem",content:a[g],value:g});f.on("click",function(a){var g=a.target.get("value");d[g]&&(this.hide(),setTimeout(function(){b.execCommand(g)},30))})}})}}},{requires:["./base","./range","./selection"]});
KISSY.Loader&&KISSY.config("modules",{"editor/plugin/heading/cmd":{requires:["editor"]},"editor/plugin/page-break/index":{requires:["editor","editor/plugin/fake-objects/"]},"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/image/dialog":{requires:["ajax","editor","editor/plugin/overlay/","switchable","editor/plugin/menubutton/"]},"editor/plugin/underline/index":{requires:["editor","editor/plugin/font/ui",
"editor/plugin/underline/cmd"]},"editor/plugin/maximize/cmd":{requires:["editor"]},"editor/plugin/contextmenu/index":{requires:["editor","menu","editor/plugin/focus-fix/"]},"editor/plugin/heading/index":{requires:["editor","editor/plugin/heading/cmd"]},"editor/plugin/drag-upload/index":{requires:["editor"]},"editor/plugin/color/cmd":{requires:["editor"]},"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/overlay/","editor/plugin/menubutton/"]},"editor/plugin/strike-through/cmd":{requires:["editor",
"editor/plugin/font/cmd"]},"editor/plugin/unordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]},"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-utils/cmd"]},"editor/plugin/italic/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]},"editor/plugin/remove-format/cmd":{requires:["editor"]},"editor/plugin/font-size/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-size/cmd"]},"editor/plugin/indent/cmd":{requires:["editor",
"editor/plugin/dent-utils/cmd"]},"editor/plugin/table/index":{requires:["editor","editor/plugin/dialog-loader/","editor/plugin/contextmenu/"]},"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/resize/index":{requires:["editor","dd"]},"editor/plugin/focus-fix/index":{requires:["editor"]},"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton/"]},"editor/plugin/xiami-music/index":{requires:["editor","editor/plugin/flash-common/baseClass",
"editor/plugin/flash-common/utils","editor/plugin/fake-objects/"]},"editor/plugin/maximize/index":{requires:["editor","editor/plugin/maximize/cmd"]},"editor/plugin/color/color-picker/dialog":{requires:["editor","editor/plugin/overlay/"]},"editor/plugin/smiley/index":{requires:["editor","editor/plugin/overlay/"]},"editor/plugin/separator/index":{requires:["editor"]},"editor/plugin/video/index":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/baseClass","editor/plugin/fake-objects/"]},
"editor/plugin/multiple-upload/index":{requires:["editor","editor/plugin/dialog-loader/"]},"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button/"]},"editor/plugin/menubutton/index":{requires:["editor","menubutton"]},"editor/plugin/flash/index":{requires:["editor","editor/plugin/flash-common/baseClass","editor/plugin/flash-common/utils","editor/plugin/fake-objects/"]},"editor/plugin/overlay/index":{requires:["editor","overlay","editor/plugin/focus-fix/","dd"]},"editor/plugin/link/utils":{requires:["editor"]},
"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton/"]},"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},"editor/plugin/button/index":{requires:["editor","button"]},"editor/plugin/checkbox-source-area/index":{requires:["editor"]},"editor/plugin/strike-through/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]},"editor/plugin/fore-color/index":{requires:["editor","editor/plugin/color/btn",
"editor/plugin/fore-color/cmd"]},"editor/plugin/flash-bridge/index":{requires:["editor","editor/plugin/flash-common/utils"]},"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/table/dialog":{requires:["editor","editor/plugin/overlay/","editor/plugin/menubutton/"]},"editor/plugin/justify-utils/cmd":{requires:["editor"]},"editor/plugin/undo/index":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd"]},"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-utils/cmd"]},
"editor/plugin/dent-utils/cmd":{requires:["editor","editor/plugin/list-utils/"]},"editor/plugin/image/index":{requires:["editor","editor/plugin/button/","editor/plugin/bubble/","editor/plugin/contextmenu/","editor/plugin/dialog-loader/"]},"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]},"editor/plugin/list-utils/index":{requires:["editor"]},"editor/plugin/dialog-loader/index":{requires:["overlay","editor"]},"editor/plugin/font-family/index":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/font-family/cmd"]},"editor/plugin/undo/cmd":{requires:["editor"]},"editor/plugin/indent/index":{requires:["editor","editor/plugin/indent/cmd"]},"editor/plugin/font/cmd":{requires:["editor"]},"editor/plugin/ordered-list/index":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]},"editor/plugin/color/btn":{requires:["editor","editor/plugin/button/","editor/plugin/overlay/","editor/plugin/dialog-loader/"]},"editor/plugin/bold/cmd":{requires:["editor",
"editor/plugin/font/cmd"]},"editor/plugin/local-storage/index":{requires:["editor","overlay","editor/plugin/flash-bridge/"]},"editor/plugin/bubble/index":{requires:["overlay","editor"]},"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/bold/index":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]},"editor/plugin/back-color/index":{requires:["editor","editor/plugin/color/btn","editor/plugin/back-color/cmd"]},"editor/plugin/draft/index":{requires:["editor",
"editor/plugin/local-storage/","overlay","editor/plugin/menubutton/"]},"editor/plugin/link/index":{requires:["editor","editor/plugin/bubble/","editor/plugin/link/utils","editor/plugin/dialog-loader/","editor/plugin/button/"]},"editor/plugin/remove-format/index":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button/"]},"editor/plugin/element-path/index":{requires:["editor"]},"editor/plugin/font/ui":{requires:["editor","editor/plugin/button/","editor/plugin/menubutton/"]},"editor/plugin/source-area/index":{requires:["editor",
"editor/plugin/button/"]},"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button/"]},"editor/plugin/justify-right/index":{requires:["editor","editor/plugin/justify-right/cmd"]},"editor/plugin/justify-left/index":{requires:["editor","editor/plugin/justify-left/cmd"]},"editor/plugin/outdent/index":{requires:["editor","editor/plugin/outdent/cmd"]},"editor/plugin/fake-objects/index":{requires:["editor"]},"editor/plugin/link/dialog":{requires:["editor","editor/plugin/overlay/","editor/plugin/link/utils"]},
"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]},"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]},"editor/plugin/multiple-upload/dialog":{requires:["editor","editor/plugin/progressbar/","editor/plugin/overlay/","editor/plugin/flash-bridge/","editor/plugin/local-storage/"]},"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-utils/cmd"]},"editor/plugin/flash-common/baseClass":{requires:["editor","editor/plugin/contextmenu/","editor/plugin/bubble/",
"editor/plugin/dialog-loader/","editor/plugin/flash-common/utils"]},"editor/plugin/justify-center/index":{requires:["editor","editor/plugin/justify-center/cmd"]},"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});
KISSY.add("editor/core/dom",function(h,k,t){function p(a,b){var i=a[b?"next":"prev"](r,1);if(i&&i[0].nodeType==d.ELEMENT_NODE){for(var w=[];i.attr("_ke_bookmark")||i._4e_isEmptyInlineRemovable(r);)if(w.push(i),i=b?i.next(r,1):i.prev(r,1),!i)return;if(a._4e_isIdentical(i,r)){for(var f=new n(b?a[0].lastChild:a[0].firstChild);w.length;)w.shift()._4e_move(a,!b,r);i._4e_moveChildren(a,!b,r);i.remove();f[0]&&f[0].nodeType==d.ELEMENT_NODE&&f._4e_mergeSiblings()}}}var r=r,c=k.XHTML_DTD,d=h.DOM,j=h.UA,n=h.Node,
m={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};k.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var u=k.POSITION,o={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,
"table-cell":1,"table-caption":1},x={hr:1},q=function(a){return a&&(a[0]||a)};t.injectDom({_4e_sameLevel:function(a,b){var b=q(b),i=a.parentNode;return i&&i==b.parentNode},_4e_isBlockBoundary:function(a,b){var i=h.merge(x,b);return!(!o[d.css(a,"display")]&&!i[d.nodeName(a)])},_4e_index:function(a,b){for(var i=a.parentNode.childNodes,d,f=-1,g=0;g<i.length;g++)if(d=i[g],!b||!(3==d.nodeType&&d.previousSibling&&3==d.previousSibling.nodeType))if(f++,d===a)return f;return-1},_4e_move:function(a,b,i){b=
q(b);i?b.insertBefore(a,b.firstChild):b.appendChild(a)},_4e_isIdentical:function(a,b){if(!b)return!1;b=q(b);if(d.nodeName(a)!=d.nodeName(b))return!1;var i=a.attributes,c=b.attributes,f=i.length,g=c.length;if(f!=g)return!1;for(var e=0;e<f;e++){var l=i[e],v=l.name;if(l.specified&&d.attr(a,v)!=d.attr(b,v))return!1}if(8>t.ieEngine)for(e=0;e<g;e++)if(l=c[e],v=l.name,l.specified&&d.attr(a,v)!=d.attr(b,v))return!1;return!0},_4e_isEmptyInlineRemovable:function(a){if(!c.$removeEmpty[d.nodeName(a)])return!1;
for(var a=a.childNodes,b=0,i=a.length;b<i;b++){var w=a[b],f=w.nodeType;if(!(f==d.ELEMENT_NODE&&w.getAttribute("_ke_bookmark"))&&(f==d.ELEMENT_NODE&&!d._4e_isEmptyInlineRemovable(w)||f==d.TEXT_NODE&&h.trim(w.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,b,i){b=q(b);if(a!=b)if(i)for(;i=a.lastChild;)b.insertBefore(a.removeChild(i),b.firstChild);else for(;i=a.firstChild;)b.appendChild(a.removeChild(i))},_4e_mergeSiblings:function(a){a=new n(a);m[a.nodeName()]&&(p(a,!0),p(a))},_4e_splitText:function(a,
b){var i=a.ownerDocument;if(a.nodeType==d.TEXT_NODE){if(j.ie&&b==a.nodeValue.length){var c=i.createTextNode("");d.insertAfter(c,a);return c}c=a.splitText(b);i.documentMode&&(i=i.createTextNode(""),d.insertAfter(i,c),d.remove(i));return c}},_4e_parents:function(a,b){var i=[];i.__IS_NODELIST=1;do i[b?"push":"unshift"](a);while(a=a.parentNode);return i},_4e_nextSourceNode:function(a,b,i,c){if(c&&!c.call)var f=q(c),c=function(a){return a!==f};var b=!b&&a.firstChild,g=a;if(!b){if(a.nodeType==d.ELEMENT_NODE&&
c&&!1===c(a,!0))return null;b=a.nextSibling}for(;!b&&(g=g.parentNode);){if(c&&!1===c(g,!0))return null;b=g.nextSibling}return!b||c&&!1===c(b)?null:i&&i!=b.nodeType?d._4e_nextSourceNode(b,!1,i,c):b},_4e_previousSourceNode:function(a,b,i,c){if(c&&!c.call)var f=q(c),c=function(a){return a!==f};var b=!b&&a.lastChild,g=a;if(!b){if(a.nodeType==d.ELEMENT_NODE&&c&&!1===c(a,!0))return null;b=a.previousSibling}for(;!b&&(g=g.parentNode);){if(c&&!1===c(g,!0))return null;b=g.previousSibling}return!b||c&&!1===
c(b)?null:i&&b.nodeType!=i?d._4e_previousSourceNode(b,!1,i,c):b},_4e_commonAncestor:function(a,b){b=q(b);if(a===b)return a;if(d.contains(b,a))return b;var i=a;do if(d.contains(i,b))return i;while(i=i.parentNode);return null},_4e_hasAttributes:9>t.ieEngine?function(a){for(var b=a.attributes,i=0;i<b.length;i++){var d=b[i];switch(d.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(d.specified)return!0}}return!1}:function(a){j.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,b){var i=q(b);if(a.compareDocumentPosition)return a.compareDocumentPosition(i);if(a==i)return u.POSITION_IDENTICAL;if(a.nodeType==d.ELEMENT_NODE&&i.nodeType==d.ELEMENT_NODE){if(d.contains(a,i))return u.POSITION_CONTAINS+u.POSITION_PRECEDING;if(d.contains(i,a))return u.POSITION_IS_CONTAINED+u.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>i.sourceIndex?u.POSITION_DISCONNECTED:a.sourceIndex<i.sourceIndex?u.POSITION_PRECEDING:u.POSITION_FOLLOWING}for(var c=
d._4e_address(a),i=d._4e_address(i),f=Math.min(c.length,i.length),g=0;g<=f-1;g++)if(c[g]!=i[g])return c[g]<i[g]?u.POSITION_PRECEDING:u.POSITION_FOLLOWING;return c.length<i.length?u.POSITION_CONTAINS+u.POSITION_PRECEDING:u.POSITION_IS_CONTAINED+u.POSITION_FOLLOWING},_4e_address:function(a,b){for(var i=[],c=a.ownerDocument.documentElement,f=a;f&&f!=c;)i.unshift(d._4e_index(f,b)),f=f.parentNode;return i},_4e_remove:function(a,b){var i=a.parentNode;if(i){if(b)for(var d;d=a.firstChild;)i.insertBefore(a.removeChild(d),
a);i.removeChild(a)}return a},_4e_trim:function(a){d._4e_ltrim(a);d._4e_rtrim(a)},_4e_ltrim:function(a){for(var b;b=a.firstChild;){if(b.nodeType==d.TEXT_NODE){var i=t.ltrim(b.nodeValue),c=b.nodeValue.length;if(i)i.length<c&&(d._4e_splitText(b,c-i.length),a.removeChild(a.firstChild));else{a.removeChild(b);continue}}break}},_4e_rtrim:function(a){for(var b;b=a.lastChild;){if(b.type==d.TEXT_NODE){var i=t.rtrim(b.nodeValue),c=b.nodeValue.length;if(i)i.length<c&&(d._4e_splitText(b,i.length),a.removeChild(a.lastChild));
else{a.removeChild(b);continue}}break}!j.ie&&!j.opera&&(b=a.lastChild)&&1==b.nodeType&&"br"==d.nodeName(b)&&a.removeChild(b)},_4e_appendBogus:function(a){for(var b=a.lastChild;b&&b.nodeType==d.TEXT_NODE&&!h.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==d.TEXT_NODE||"br"!==d.nodeName(b))b=j.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br"),j.gecko&&b.setAttribute("type","_moz"),a.appendChild(b)},_4e_outerHtml:function(a){if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,
"");var b=a.ownerDocument.createElement("div");b.appendChild(a.cloneNode(!0));return b.innerHTML},_4e_setMarker:function(a,b,i,d){var a=new n(a),f=a.data("list_marker_id")||a.data("list_marker_id",h.guid()).data("list_marker_id"),g=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");b[f]=a;g[i]=1;return a.data(i,d)},_4e_clearMarkers:function(a,b,i){var a=new n(a),d=a.data("list_marker_names"),f=a.data("list_marker_id"),g;for(g in d)d.hasOwnProperty(g)&&a.removeData(g);
a.removeData("list_marker_names");i&&(a.removeData("list_marker_id"),delete b[f])},_4e_copyAttributes:function(a,b,i){for(var b=new n(b),c=a.attributes,i=i||{},f=0;f<c.length;f++){var g=c[f],e=g.name.toLowerCase(),l;if(!(e in i))if("checked"==e&&(l=d.attr(a,e)))b.attr(e,l);else if(g.specified||j.ie&&g.value&&"value"==e)l=d.attr(a,e),null===l&&(l=g.nodeValue),b.attr(e,l)}""!==a.style.cssText&&(b[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=d.nodeName(a);return(a=!c.$nonEditable[a]&&
(c[a]||c.span))&&a["#text"]},_4e_getByAddress:function(a,b,i){for(var a=a.documentElement,d=0;a&&d<b.length;d++){var f=b[d];if(i)for(var g=-1,e=0;e<a.childNodes.length;e++){var l=a.childNodes[e];if(!(!0===i&&3==l.nodeType&&l.previousSibling&&3==l.previousSibling.nodeType)&&(g++,g==f)){a=l;break}}else a=a.childNodes[f]}return a}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(h){function k(d){1>arguments.length||(this.range=d,this.forceBrBreak=p,this.enlargeBr=t,this.enforceRealBlocks=p,this._||(this._={}))}var t=!0,p=!1,r=h.Editor,c=h.UA,d=r.Walker,j=r.Range,n=r.RANGE,m=r.ElementPath,u=h.Node,o=h.DOM,x=/^[\r\n\t ]*$/;h.augment(k,{getNextParagraph:function(k){var a,b,i,w,f;if(!this._.lastNode){b=this.range.clone();b.shrink(n.SHRINK_ELEMENT,t);b.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:n.ENLARGE_BLOCK_CONTENTS);
var g=new d(b),e=d.bookmark(t,t);g.evaluator=e;this._.nextNode=g.next();g=new d(b);g.evaluator=e;g=g.previous();this._.lastNode=g._4e_nextSourceNode(t);this._.lastNode&&this._.lastNode[0].nodeType==o.TEXT_NODE&&!h.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(e=new j(b.document),e.moveToPosition(this._.lastNode,n.POSITION_AFTER_END),e.checkEndOfBlock()&&(e=new m(e.endContainer),this._.lastNode=(e.block||e.blockLimit)._4e_nextSourceNode(t)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new u(b.document.createTextNode("")),o.insertAfter(this._.lastNode[0],g[0]));b=null}e=this._.nextNode;g=this._.lastNode;for(this._.nextNode=null;e;){var l=p,v=e[0].nodeType!=o.ELEMENT_NODE,z=p;if(v)e[0].nodeType==o.TEXT_NODE&&x.test(e[0].nodeValue)&&(v=p);else{var y=e.nodeName();if(e._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==y)v=t;else if(!b&&!e[0].childNodes.length&&"hr"!=y){a=e;i=e.equals(g);break}b&&(b.setEndAt(e,n.POSITION_BEFORE_START),"br"!=
y&&(this._.nextNode=e));l=t}else{if(e[0].firstChild){b||(b=new j(this.range.document),b.setStartAt(e,n.POSITION_BEFORE_START));e=new u(e[0].firstChild);continue}v=t}}v&&!b&&(b=new j(this.range.document),b.setStartAt(e,n.POSITION_BEFORE_START));i=(!l||v)&&e.equals(g);if(b&&!l)for(;!e[0].nextSibling&&!i;){y=e.parent();if(y._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){l=t;i||y.equals(g);break}e=y;v=t;i=e.equals(g);z=t}v&&b.setEndAt(e,n.POSITION_AFTER_END);e=e._4e_nextSourceNode(z,null,g);if((i=!e)||
l&&b)break}if(!a){if(!b)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;a=new m(b.startContainer);e=a.blockLimit;l={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&l[e.nodeName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())a=e;else if(!a||this.enforceRealBlocks&&"li"==a.nodeName())a=new u(this.range.document.createElement(k||"p")),a[0].appendChild(b.extractContents()),a._4e_trim(),b.insertNode(a),w=f=t;else if("li"!=a.nodeName()){if(!b.checkStartOfBlock()||
!b.checkEndOfBlock())a=a.clone(p),a[0].appendChild(b.extractContents()),a._4e_trim(),f=b.splitBlock(),w=!f.wasStartOfBlock,f=!f.wasEndOfBlock,b.insertNode(a)}else i||(this._.nextNode=a.equals(g)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(t,null,g))}w&&(b=new u(a[0].previousSibling),b[0]&&b[0].nodeType==o.ELEMENT_NODE&&("br"==b.nodeName()?b._4e_remove():b[0].lastChild&&"br"==o.nodeName(b[0].lastChild)&&o._4e_remove(b[0].lastChild)));f&&(b=d.bookmark(p,t),w=new u(a[0].lastChild),w[0]&&w[0].nodeType==
o.ELEMENT_NODE&&"br"==w.nodeName()&&(c.ie||w.prev(b,1)||w.next(b,1))&&w.remove());this._.nextNode||(this._.nextNode=i||a.equals(g)?null:a._4e_nextSourceNode(t,null,g));return a}});j.prototype.createIterator=function(){return new k(this)};return k},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(h){function k(h){for(var m=c,k=c,o=[];h;){if(h[0].nodeType==p.ELEMENT_NODE){this.lastElement||(this.lastElement=h);var x=h.nodeName();if(!k&&(!m&&d[x]&&(m=h),j[x])){var q;if(q=!m)if(q="div"==x){a:{q=h[0].childNodes;for(var a=0,b=q.length;a<b;a++){var i=q[a];if(i.nodeType==p.ELEMENT_NODE&&r.$block[i.nodeName.toLowerCase()]){q=!0;break a}}q=!1}q=!q}q?m=h:k=h}o.push(h);if("body"==x)break}h=h.parent()}this.block=m;this.blockLimit=k;this.elements=o}var t=h.Editor,
p=h.DOM,r=t.XHTML_DTD,c=null,d={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};k.prototype={compare:function(d){var c=this.elements,d=d&&d.elements;if(!d||c.length!=d.length)return!1;for(var h=0;h<c.length;h++)if(!p.equals(c[h],d[h]))return!1;return!0},contains:function(d){for(var h=this.elements,j=0;j<h.length;j++)if(h[j].nodeName()in d)return h[j];return c},toString:function(){var d=this.elements,
c,h=[];for(c=0;c<d.length;c++)h.push(d[c].nodeName());return h.toString()}};return t.ElementPath=k},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(h,k,t,p){function r(c){var k;k=c.getSelection().getRanges();for(var q=k.length-1;0<q;q--)k[q].deleteContents();k=k[0];q=k.document;if(k.checkStartOfBlock()&&k.checkEndOfBlock()){var a=(new p(k.startContainer)).block;if(a&&("li"==a.nodeName()||"li"==a.parent().nodeName()))return c.hasCommand("outdent")?(c.execCommand("save"),c.execCommand("outdent"),c.execCommand("save"),!0):!1}var b=k.splitBlock("p");if(!b)return!0;var c=b.previousBlock,a=b.nextBlock,i=b.wasStartOfBlock,
w=b.wasEndOfBlock,f;if(a)f=a.parent(),"li"==f.nodeName()&&(a._4e_breakParent(f),a._4e_move(a.next(),!0));else if(c&&(f=c.parent())&&"li"==f.nodeName())c._4e_breakParent(f),k.moveToElementEditablePosition(c.next()),c._4e_move(c.prev());if(!i&&!w){if("li"==a.nodeName()&&(f=a.first(t.invisible(!0)))&&h.inArray(f.nodeName(),["ul","ol"]))(d.ie?new m(q.createTextNode("\u00a0")):new m(q.createElement("br"))).insertBefore(f);a&&k.moveToElementEditablePosition(a)}else{var g;if(c){if("li"==c.nodeName()||!j.test(c.nodeName()))g=
c.clone()}else a&&(g=a.clone());g||(g=new m("<p>",null,q));if(f=b.elementPath)for(var b=0,e=f.elements.length;b<e;b++){var l=f.elements[b];if(l.equals(f.block)||l.equals(f.blockLimit))break;n.$removeEmpty[l.nodeName()]&&(l=l.clone(),g._4e_moveChildren(l),g.append(l))}d.ie||g._4e_appendBogus();k.insertNode(g);if(d.ie&&i&&(!w||!c[0].childNodes.length))k.moveToElementEditablePosition(w?c:g),k.select();k.moveToElementEditablePosition(i&&!w?a:g)}d.ie||(a?(g=new m(q.createElement("span")),g.html("&nbsp;"),
k.insertNode(g),g.scrollIntoView(void 0,!1),k.deleteContents()):g.scrollIntoView(void 0,!1));k.select();return!0}function c(c){var d=c.get("document")[0];u.on(d,"keydown",function(d){if(13===d.keyCode&&!d.shiftKey&&!d.ctrlKey&&!d.metaKey){c.execCommand("save");var a=c.execCommand("enterBlock");c.execCommand("save");!1!==a&&d.preventDefault()}})}var d=h.UA,j=/^h[1-6]$/,n=k.XHTML_DTD,m=h.Node,u=h.Event;return{init:function(d){d.addCommand("enterBlock",{exec:r});d.docReady(function(){c(d)})}}},{requires:["./base",
"./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(h){function k(){var c=this;c.__iframeFocus=n;j=c;d&&clearTimeout(d);d=setTimeout(function(){c.fire("focus")},100)}function t(){var c=this;c.__iframeFocus=m;j=u;d&&clearTimeout(d);d=setTimeout(function(){c.fire("blur")},100)}var p=h.Editor,r=h.Event,c={},d,j,h={refreshAll:function(){for(var d in c)if(c.hasOwnProperty(d)){var h=c[d].get("document")[0];h.designMode="off";h.designMode="on"}},currentInstance:function(){return j},getInstance:function(d){return c[d]},
add:function(c){var d=c.get("window")[0];r.on(d,"focus",k,c);r.on(d,"blur",t,c)},register:function(d){c[d._UUID]=d},remove:function(d){delete c[d._UUID];var h=d.get("window")[0];r.remove(h,"focus",k,d);r.remove(h,"blur",t,d)}},n=!0,m=!1,u=null;h.refreshAll=h.refreshAll;p.focusManager=h;p.getInstances=function(){return c};return h},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(h,k){return{init:function(t){function p(a){if((a.getAttribute("class")+"").match(/Apple-\w+-span/)||!a.attributes.length)a.setTagName(null);else if(!a.childNodes.length&&!a.attributes.length)return!1}function r(a){return a.replace(x,function(a,e,b){return"<"+e+b.replace(q,function(a,e){return-1==b.indexOf("_ke_saved_"+e)?" _ke_saved_"+a+" "+a:a})+">"})}function c(a){return a.replace(b,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function d(a){return a.replace(i,function(a,e){return decodeURIComponent(e)})}var j=h.Node,n=h.UA,m=h.require("htmlparser"),u=new m.Filter,o=new m.Filter;(function(){function e(e){e=m.serialize(e);return new m.Comment(a+encodeURIComponent(e).replace(/--/g,"%2D%2D"))}var b={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:e,noscript:e,span:p}},g={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var e=
["name","href","src"],b,g=0;g<e.length;g++)b="_ke_saved_"+e[g],a.getAttribute(b)&&a.removeAttribute(e[g]);return a},embed:function(a){var e=a.parentNode;if(e&&"object"==e.nodeName){var b=e.getAttribute("width"),e=e.getAttribute("height");b&&a.setAttribute("width",b);e&&a.setAttribute("width",e)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:p},attributes:{style:function(a){if(!h.trim(a))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(e){if(e.substr(0,a.length)==a)return e=h.trim(decodeURIComponent(e.substr(a.length))),m.parse(e).childNodes[0]}};n.ie&&(g.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});u.addRules(g);o.addRules(b)})();(function(){function a(s){for(var s=s.childNodes,e=s.length,b=s[e-1];b&&3==b.nodeType&&!h.trim(b.nodeValue);)b=s[--e];return b}function b(s,F){var g=a(s);g&&((F||!n.ie)&&1==g.nodeType&&"br"==g.nodeName?s.removeChild(g):
3==g.nodeType&&i.test(g.nodeValue)&&s.removeChild(g))}function g(s){var b=a(s);return!b||1==b.nodeType&&"br"==b.nodeName||"form"==s.nodeName&&"input"==b.nodeName}function f(a){b(a,!0);g(a)&&(n.ie?a.appendChild(new m.Text("\u00a0")):(a.appendChild(new m.Text("&nbsp;")),a.appendChild(new m.Tag("br"))))}function d(a){b(a,!1);g(a)&&a.appendChild(new m.Text("\u00a0"))}var i=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,c=k.XHTML_DTD,F=h.merge(c.$block,c.$listItem,c.$tableContent),A;for(A in F)F.hasOwnProperty(A)&&("br"in c[A]||
delete F[A]);delete F.td;delete F.pre;var c={tags:{}},J={tags:{}};for(A in F)F.hasOwnProperty(A)&&(c.tags[A]=f,J.tags[A]=d);o.addRules(c);u.addRules(J)})();u.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var x=/<(a|area|img|input)\b([^>]*)>/gi,q=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,a="{ke_protected}",b=/(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,i=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,w=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,
f=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,g=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;t.htmlDataProcessor={dataFilter:o,htmlFilter:u,toHtml:function(a){var b=new m.BeautifyWriter;(new m.Parser(a)).parse().writeHtml(b,u);return a=b.getHtml()},toDataFormat:function(a,b){var b=b||o,a=r(a),a=c(a),a=a.replace(w,"$1ke:$2"),a=a.replace(g,"<ke:$1$2></ke:$1>"),i=new j("<div>");i.html("a"+a);a=i.html().substr(1);a=a.replace(f,"$1$2");a=d(a);i=new m.BasicWriter;
(new m.Parser(a)).parse().writeHtml(i,b);return a=i.getHtml()},toServer:function(a){var b=new m.MinifyWriter;(new m.Parser(a)).parse().writeHtml(b,u);return b.getHtml()}}}}},{requires:["./base"]});
KISSY.add("editor/core/range",function(h,k,t,p,r){function c(a){var b=a.nodeType!=i.TEXT_NODE&&i.nodeName(a)in f.$removeEmpty,g=a.nodeType==i.TEXT_NODE&&!h.trim(a.nodeValue),a=!!a.parentNode.getAttribute("_ke_bookmark");return b||g||a}function d(a){return!v(a)&&!z(a)}function j(a){var b=x;return function(g){if(z(g))return o;if(g.nodeType==i.TEXT_NODE){if(h.trim(g.nodeValue).length)return x}else if(g.nodeType==i.ELEMENT_NODE&&(g=i.nodeName(g),!G[g]))if(!a&&!w.ie&&"br"==g&&!b)b=o;else return x;return o}}
function n(a,b){var e=a.startContainer,s=a.endContainer,f=a.startOffset,d=a.endOffset,c,l=x,h=x,v=void 0,j=a.document,Q;0<b&&(v=j.createDocumentFragment());if(a.collapsed)return v;a.optimizeBookmark();s[0].nodeType==i.TEXT_NODE?(h=o,s=s._4e_splitText(d)):0<s[0].childNodes.length&&(d>=s[0].childNodes.length?(s=new g(s[0].appendChild(j.createTextNode(""))),Q=o):s=new g(s[0].childNodes[d]));e[0].nodeType==i.TEXT_NODE?(l=o,e._4e_splitText(f)):f?f>=e[0].childNodes.length?(e=new g(e[0].appendChild(j.createTextNode(""))),
c=o):e=new g(e[0].childNodes[f].previousSibling):(c=new g(j.createTextNode("")),e.prepend(c),e=c,c=o);var I=e._4e_parents(),K=s._4e_parents();I.each(function(a,b){I[b]=a});K.each(function(a,b){K[b]=a});for(var E,M,j=0;j<I.length&&!(E=I[j],M=K[j],!E.equals(M));j++);for(var f=v,B,k,z=j;z<I.length;z++){B=I[z];d=0<b&&!B.equals(e)?f.appendChild(B.clone()[0]):null;B=B[0].nextSibling;k=K[z];for(var m=s[0],n=k&&k[0];B&&!(n==B||m==B);)k=B.nextSibling,2==b?f.appendChild(B.cloneNode(o)):(i._4e_remove(B),1==
b&&f.appendChild(B)),B=k;d&&(f=d)}for(f=v;j<K.length;j++){B=K[j];d=0<b&&!B.equals(s)?f.appendChild(B.clone()[0]):null;if(!I[j]||!B._4e_sameLevel(I[j]))for(B=B[0].previousSibling;B;)k=B.previousSibling,2==b?f.insertBefore(B.cloneNode(o),f.firstChild):(i._4e_remove(B),1==b&&f.insertBefore(B,f.firstChild)),B=k;d&&(f=d)}if(2==b){if(l&&(E=e[0],E.nodeType==i.TEXT_NODE&&E.nextSibling&&E.nextSibling.nodeType==i.TEXT_NODE&&(E.data+=E.nextSibling.data,E.parentNode.removeChild(E.nextSibling))),h)h=s[0],h.nodeType==
i.TEXT_NODE&&h.previousSibling&&h.previousSibling.nodeType==i.TEXT_NODE&&(h.previousSibling.data+=h.data,h.parentNode.removeChild(h))}else{if(E&&M&&(!e._4e_sameLevel(E)||!s._4e_sameLevel(M)))h=E._4e_index(),c&&E._4e_sameLevel(e)&&h--,a.setStart(E.parent(),h+1);a.collapse(o)}c&&e.remove();Q&&s.remove();return v}function m(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function u(a){this.endOffset=this.endContainer=this.startOffset=
this.startContainer=q;this.collapsed=o;this.document=a}k.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=!0,x=!1,q=null,a=k.RANGE,b=k.POSITION,i=h.DOM,w=h.UA,f=k.XHTML_DTD,g=h.Node,e=g.all,l={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},v=new p.whitespaces,z=new p.bookmark,y=p.whitespaces(o),C=p.bookmark(!1,
!0),G={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};h.augment(u,{toString:function(){var a=[],b=this.startContainer[0],g=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((g.id||g.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,b=this.startOffset;a[0].nodeType!=i.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&
this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=i.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,
b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==i.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);m(this)},setEnd:function(a,b){a[0].nodeType==i.ELEMENT_NODE&&l[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=
b;this.startContainer||(this.startContainer=a,this.startOffset=b);m(this)},setStartAt:function(b,g){switch(g){case a.POSITION_AFTER_START:this.setStart(b,0);break;case a.POSITION_BEFORE_END:b[0].nodeType==i.TEXT_NODE?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setStartBefore(b);break;case a.POSITION_AFTER_END:this.setStartAfter(b)}m(this)},setEndAt:function(b,g){switch(g){case a.POSITION_AFTER_START:this.setEnd(b,0);break;
case a.POSITION_BEFORE_END:b[0].nodeType==i.TEXT_NODE?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case a.POSITION_BEFORE_START:this.setEndBefore(b);break;case a.POSITION_AFTER_END:this.setEndAfter(b)}m(this)},cloneContents:function(){return n(this,2)},deleteContents:function(){return n(this,0)},extractContents:function(){return n(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,
this.startOffset=this.endOffset);this.collapsed=o},clone:function(){var a=new u(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=i.ELEMENT_NODE||a.endContainer[0].nodeType!=i.ELEMENT_NODE)return q;var b=new p(a);b.evaluator=function(a){return y(a)&&C(a)};a=b.next();b.reset();b=
b.previous();return a&&a.equals(b)?a:q},shrink:function(b,g){if(!this.collapsed){var b=b||a.SHRINK_TEXT,e=this.clone(),s=this.startContainer,f=this.endContainer,d=this.startOffset,c=this.endOffset,l=o,h,v,j=o;s&&s[0].nodeType==i.TEXT_NODE&&(d?d>=s[0].nodeValue.length?e.setStartAfter(s):(e.setStartBefore(s),l=x):e.setStartBefore(s));f&&f[0].nodeType==i.TEXT_NODE&&(c?c>=f[0].nodeValue.length?e.setEndAfter(f):(e.setEndAfter(f),j=x):e.setEndBefore(f));if(l||j)v=new p(e),v.evaluator=function(g){return g.nodeType==
(b==a.SHRINK_ELEMENT?i.ELEMENT_NODE:i.TEXT_NODE)},v.guard=function(g,s){if(b==a.SHRINK_ELEMENT&&g.nodeType==i.TEXT_NODE||s&&g==h)return x;!s&&g.nodeType==i.ELEMENT_NODE&&(h=g);return o};l&&(e=v[b==a.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(e,g?a.POSITION_AFTER_START:a.POSITION_BEFORE_START);j&&(v.reset(),(v=v[b==a.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(v,g?a.POSITION_BEFORE_END:a.POSITION_AFTER_END));return l||j}},createBookmark2:function(a){var b=this.startContainer,
e=this.endContainer,s=this.startOffset,f=this.endOffset,d,c;if(!b||!e)return{start:0,end:0};if(a){if(b[0].nodeType==i.ELEMENT_NODE&&(d=new g(b[0].childNodes[s]))&&d[0]&&d[0].nodeType==i.TEXT_NODE&&0<s&&d[0].previousSibling.nodeType==i.TEXT_NODE)b=d,s=0;for(;b[0].nodeType==i.TEXT_NODE&&(c=b.prev(void 0,1))&&c[0].nodeType==i.TEXT_NODE;)b=c,s+=c[0].nodeValue.length;if(!this.collapsed){if(e[0].nodeType==i.ELEMENT_NODE&&(d=new g(e[0].childNodes[f]))&&d[0]&&d[0].nodeType==i.TEXT_NODE&&0<f&&d[0].previousSibling.nodeType==
i.TEXT_NODE)e=d,f=0;for(;e[0].nodeType==i.TEXT_NODE&&(c=e.prev(void 0,1))&&c[0].nodeType==i.TEXT_NODE;)e=c,f+=c[0].nodeValue.length}}return{start:b._4e_address(a),end:this.collapsed?q:e._4e_address(a),startOffset:s,endOffset:f,normalized:a,is2:o}},createBookmark:function(b){var e,f,s,d,c=this.collapsed;e=new g("<span>",q,this.document);e.attr("_ke_bookmark",1);e.css("display","none");e.html("&nbsp;");b&&(s=h.guid("ke_bm_"),e.attr("id",s+"S"));c||(f=e.clone(),f.html("&nbsp;"),b&&f.attr("id",s+"E"),
d=this.clone(),d.collapse(),d.insertNode(f));d=this.clone();d.collapse(o);d.insertNode(e);f?(this.setStartAfter(e),this.setEndBefore(f)):this.moveToPosition(e,a.POSITION_AFTER_END);return{startNode:b?s+"S":e,endNode:b?s+"E":f,serializable:b,collapsed:c}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(o)},trim:function(a,b){var e=this.startContainer,g=this.startOffset,f=this.collapsed;if((!a||f)&&e[0]&&e[0].nodeType==i.TEXT_NODE){if(g)if(g>=e[0].nodeValue.length)g=e._4e_index()+1,
e=e.parent();else{var d=e._4e_splitText(g),g=e._4e_index()+1,e=e.parent();i.equals(this.startContainer,this.endContainer)?this.setEnd(d,this.endOffset-this.startOffset):i.equals(e,this.endContainer)&&(this.endOffset+=1)}else g=e._4e_index(),e=e.parent();this.setStart(e,g);if(f){this.collapse(o);return}}e=this.endContainer;g=this.endOffset;!b&&!f&&e[0]&&e[0].nodeType==i.TEXT_NODE&&(g?(g>=e[0].nodeValue.length||e._4e_splitText(g),g=e._4e_index()+1):g=e._4e_index(),e=e.parent(),this.setEnd(e,g))},insertNode:function(a){this.optimizeBookmark();
this.trim(x,o);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(a){var b=e(this.document);if(a.is2){var g=b._4e_getByAddress(a.start,a.normalized),f=a.startOffset,b=a.end&&b._4e_getByAddress(a.end,a.normalized),a=a.endOffset;this.setStart(g,f);b?this.setEnd(b,a):this.collapse(o)}else g=(f=a.serializable)?h.one("#"+a.startNode,b):a.startNode,a=f?h.one("#"+a.endNode,
b):a.endNode,this.setStartBefore(g),g._4e_remove(),a&&a[0]?(this.setEndBefore(a),a._4e_remove()):this.collapse(o)},getCommonAncestor:function(a,b){var e=this.startContainer,f=this.endContainer,e=e[0]==f[0]?a&&e[0].nodeType==i.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new g(e[0].childNodes[this.startOffset]):e:e._4e_commonAncestor(f);return b&&e[0].nodeType==i.TEXT_NODE?e.parent():e},enlarge:function(){function b(a,g,f,d){var c=a[g?"startContainer":"endContainer"],l,h=g?0:1,j=0,k=g?"previousSibling":
"nextSibling";l=a[g?"startOffset":"endOffset"];if(c[0].nodeType==i.TEXT_NODE){if(g){if(l)return}else if(l<c[0].nodeValue.length)return;l=c[0][k];c=c[0].parentNode}else l=c[0].childNodes[l+(g?-1:1)]||null,c=c[0];for(;c;){for(;l;)if(v(l)||z(l))l=l[k];else break;if(l){if(!j)a[g?"setStartAfter":"setEndBefore"](e(l));break}c=e(c);if("body"==c.nodeName())break;if(j||c.equals(d))f[h]=c,j=1;else a[g?"setStartBefore":"setEndAfter"](c);l=c[0][k];c=c[0].parentNode}}return function(f){switch(f){case a.ENLARGE_ELEMENT:if(this.collapsed)break;
var f=this.getCommonAncestor(),c=[];b(this,1,c,f);b(this,0,c,f);c[0]&&c[1]&&(f=c[0].contains(c[1])?c[1]:c[0],this.setStartBefore(f),this.setEndAfter(f));break;case a.ENLARGE_BLOCK_CONTENTS:case a.ENLARGE_LIST_ITEM_CONTENTS:var d=new u(this.document),c=new g(this.document.body);d.setStartAt(c,a.POSITION_AFTER_START);d.setEnd(this.startContainer,this.startOffset);var d=new p(d),l,h,v=p.blockBoundary(f==a.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:q),j=function(a){var b=v(a);b||(l=e(a));return b},k=function(a){var b=
j(a);!b&&"br"==i.nodeName(a)&&(h=e(a));return b};d.guard=j;d=d.lastBackward();l=l||c;this.setStartAt(l,"br"!=l.nodeName()&&(!d&&this.checkStartOfBlock()||d&&l.contains(d))?a.POSITION_AFTER_START:a.POSITION_AFTER_END);d=this.clone();d.collapse();d.setEndAt(c,a.POSITION_BEFORE_END);d=new p(d);d.guard=f==a.ENLARGE_LIST_ITEM_CONTENTS?k:j;l=q;d=d.lastForward();l=l||c;this.setEndAt(l,!d&&this.checkEndOfBlock()||d&&l.contains(d)?a.POSITION_BEFORE_END:a.POSITION_BEFORE_START);h&&this.setEndAfter(h)}}}(),
checkStartOfBlock:function(){var b=this.startContainer,e=this.startOffset;if(e&&b[0].nodeType==i.TEXT_NODE&&h.trim(b[0].nodeValue.substring(0,e)).length)return x;this.trim();b=new r(this.startContainer);e=this.clone();e.collapse(o);e.setStartAt(b.block||b.blockLimit,a.POSITION_AFTER_START);b=new p(e);b.evaluator=j(o);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,e=this.endOffset;if(b[0].nodeType==i.TEXT_NODE&&h.trim(b[0].nodeValue.substring(e)).length)return x;this.trim();
b=new r(this.endContainer);e=this.clone();e.collapse(x);e.setEndAt(b.block||b.blockLimit,a.POSITION_BEFORE_END);b=new p(e);b.evaluator=j(x);return b.checkForward()},checkBoundaryOfElement:function(b,e){var g=this.clone();g[e==a.START?"setStartAt":"setEndAt"](b,e==a.START?a.POSITION_AFTER_START:a.POSITION_BEFORE_END);g=new p(g);g.evaluator=c;return g[e==a.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,g=this.endContainer,f=this.startOffset,d=this.endOffset,
c;if(a[0].nodeType==i.ELEMENT_NODE)if(c=a[0].childNodes.length,c>f)a=e(a[0].childNodes[f]);else if(0==c)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=e(a);a=a._4e_nextSourceNode()||a}if(g[0].nodeType==i.ELEMENT_NODE)if(c=g[0].childNodes.length,c>d)g=e(g[0].childNodes[d])._4e_previousSourceNode(o);else if(0==c)g=g._4e_previousSourceNode();else{for(g=g[0];g.lastChild;)g=g.lastChild;g=e(g)}a._4e_position(g)&b.POSITION_FOLLOWING&&(a=g);return{startNode:a,endNode:g}},fixBlock:function(b,
g){var f=this.createBookmark(),c=e(this.document.createElement(g));this.collapse(b);this.enlarge(a.ENLARGE_BLOCK_CONTENTS);c[0].appendChild(this.extractContents());c._4e_trim();w.ie||c._4e_appendBogus();this.insertNode(c);this.moveToBookmark(f);return c},splitBlock:function(b){var e=new r(this.startContainer),g=new r(this.endContainer),f=e.block,c=g.block,d=q;if(!e.blockLimit.equals(g.blockLimit))return q;"br"!=b&&(f||(f=this.fixBlock(o,b),c=(new r(this.endContainer)).block),c||(c=this.fixBlock(x,
b)));b=f&&this.checkStartOfBlock();e=c&&this.checkEndOfBlock();this.deleteContents();f&&f[0]==c[0]&&(e?(d=new r(this.startContainer),this.moveToPosition(c,a.POSITION_AFTER_END),c=q):b?(d=new r(this.startContainer),this.moveToPosition(f,a.POSITION_BEFORE_START),f=q):(c=this.splitElement(f),!w.ie&&!h.inArray(f.nodeName(),["ul","ol"])&&f._4e_appendBogus()));return{previousBlock:f,nextBlock:c,wasStartOfBlock:b,wasEndOfBlock:e,elementPath:d}},splitElement:function(b){if(!this.collapsed)return q;this.setEndAt(b,
a.POSITION_BEFORE_END);var e=this.extractContents(),g=b.clone(x);g[0].appendChild(e);g.insertAfter(b);this.moveToPosition(b,a.POSITION_AFTER_END);return g},moveToElementEditablePosition:function(b,e){for(var g=0;b;){if(b[0].nodeType==i.TEXT_NODE){this.moveToPosition(b,e?a.POSITION_AFTER_END:a.POSITION_BEFORE_START);g=1;break}b[0].nodeType==i.ELEMENT_NODE&&b._4e_isEditable()&&(this.moveToPosition(b,e?a.POSITION_BEFORE_END:a.POSITION_AFTER_START),g=1);var f=b,c=g,l=void 0;f[0].nodeType==i.ELEMENT_NODE&&
f._4e_isEditable()&&(l=f[e?"last":"first"](d,1));!c&&!l&&(l=f[e?"prev":"next"](d,1));b=l}return!!g},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==i.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,e,g,c=a.nodeName();b=f.$block[c];this.deleteContents();if(b){for(b=this.getCommonAncestor(x,o);(e=f[b.nodeName()])&&(!e||!e[c]);){var d=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(o),
b.remove()):g=b;b=d}g&&this.splitElement(g)}this.insertNode(a)}});t.injectDom({_4e_breakParent:function(a,b){var b=e(b),a=e(a),g,f=new k.Range(a[0].ownerDocument);f.setStartAfter(a);f.setEndAfter(b);g=f.extractContents();f.insertNode(a.remove());a.after(g)}});return k.Range=u},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(h){function k(a){this.document=a;this._={cache:{}};if(o)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=r}catch(e){this.isInvalid=r}}function t(a){a=new k(a);return!a||a.isInvalid?c:a}var p=h.Editor;p.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var r=!0,c=null,d=h.UA,j=h.DOM,n=h.Node,m=p.SELECTION,u=p.RANGE,o=d.ie,x=p.Walker,q=p.Range,
a={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};h.augment(k,{getNative:!o?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=j._getWin(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!o?function(){var b=this._.cache;if(b.type)return b.type;var g=m.SELECTION_TEXT,e=this.getNative();if(e){if(1==e.rangeCount){var e=
e.getRangeAt(0),c=e.startContainer;c==e.endContainer&&c.nodeType==j.ELEMENT_NODE&&1==Number(e.endOffset-e.startOffset)&&a[c.childNodes[e.startOffset].nodeName.toLowerCase()]&&(g=m.SELECTION_ELEMENT)}}else g=m.SELECTION_NONE;return b.type=g}:function(){var a=this._.cache;if(a.type)return a.type;var b=m.SELECTION_NONE;try{var e=this.getNative(),c=e.type;"Text"==c&&(b=m.SELECTION_TEXT);"Control"==c&&(b=m.SELECTION_ELEMENT);e.createRange().parentElement&&(b=m.SELECTION_TEXT)}catch(d){}return a.type=b},
getRanges:o?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var d=a.parentElement(),f=d.childNodes,i,h=0;h<f.length;h++){var k=f[h];if(k.nodeType==j.ELEMENT_NODE){i=a.duplicate();i.moveToElementText(k);var k=i.compareEndPoints("StartToStart",a),m=i.compareEndPoints("EndToStart",a);i.collapse();if(0<k)break;else{if(!k||1==m&&-1==k)return{container:d,offset:h};if(!m)return{container:d,offset:h+1}}i=c}}i||(i=a.duplicate(),i.moveToElementText(d),i.collapse(!1));i.setEndPoint("StartToStart",
a);i=(""+i.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<i;)i-=f[--h].nodeValue.length}catch(n){i=0}return 0===i?{container:d,offset:h}:{container:f[h],offset:-i}};return function(b){var e=this._.cache;if(e.ranges&&!b)return e.ranges;var c=this.getNative(),b=c&&c.createRange(),d=this.getType();if(!c)return[];if(d==m.SELECTION_TEXT)return c=new q(this.document),d=a(b,r),c.setStart(new n(d.container),d.offset),d=a(b),c.setEnd(new n(d.container),d.offset),e.ranges=[c];if(d==m.SELECTION_ELEMENT){e=
e.ranges=[];for(d=0;d<b.length;d++){for(var i=b.item(d),h=i.parentNode,j=0,c=new q(this.document);j<h.childNodes.length&&h.childNodes[j]!=i;j++);c.setStart(new n(h),j);c.setEnd(new n(h),j+1);e.push(c)}return e}return e.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],e=this.getNative();if(!e)return[];for(var c=0;c<e.rangeCount;c++){var d=e.getRangeAt(c),i=new q(this.document);i.setStart(new n(d.startContainer),d.startOffset);i.setEnd(new n(d.endContainer),d.endOffset);
a.push(i)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,e=this.getNative();switch(this.getType()){case m.SELECTION_ELEMENT:return this.getSelectedElement();case m.SELECTION_TEXT:var c=this.getRanges()[0];if(c&&!c.collapsed){for(c.optimize();r;)if(b=c.startContainer,c.startOffset==(b[0].nodeType===j.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())c.setStartAfter(b);else break;b=c.startContainer;
if(b[0].nodeType!=j.ELEMENT_NODE)return b.parent();b=new n(b[0].childNodes[c.startOffset]);if(!b[0]||b[0].nodeType!=j.ELEMENT_NODE)return c.startContainer;for(c=b[0].firstChild;c&&c.nodeType==j.ELEMENT_NODE;)b=new n(c),c=c.firstChild;return b}if(o)c=e.createRange(),c.collapse(r),b=new n(c.parentElement());else{if((b=e.anchorNode)&&b.nodeType!=j.ELEMENT_NODE)b=b.parentNode;b&&(b=new n(b))}}return a.startElement=b},getSelectedElement:function(){var b,c=this._.cache;if(void 0!==c.selectedElement)return c.selectedElement;
o&&(b=this.getNative().createRange(),b=b.item&&b.item(0));if(b)b=new n(b);else{b=this.getRanges()[0];for(var e,d,i=2;i&&(!(e=b.getEnclosedNode())||!(e[0].nodeType==j.ELEMENT_NODE&&a[e.nodeName()]&&(d=e)));i--)b.shrink(u.SHRINK_ELEMENT);b=d}return c.selectedElement=b},reset:function(){this._.cache={}},selectElement:function(a){var b,c=this.document;if(o)try{b=c.body.createControlRange(),b.addElement(a[0]),b.select()}catch(d){b=c.body.createTextRange(),b.moveToElementText(a[0]),b.select()}finally{}else b=
c.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(o){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select();this.reset()}else if(b=this.getNative()){b.removeAllRanges();for(var c=0;c<a.length;c++){var i=a[c],h=this.document.createRange(),k=i.startContainer;if(i.collapsed&&(d.gecko&&1.09>d.gecko||d.opera||d.webkit)&&k[0].nodeType==j.ELEMENT_NODE&&!k[0].childNodes.length)k[0].appendChild(this.document.createTextNode(d.webkit?
"\u200b":"")),i.startOffset++,i.endOffset++;h.setStart(k[0],i.startOffset);h.setEnd(i.endContainer[0],i.endOffset);b.addRange(h)}this.reset()}},createBookmarks2:function(a){for(var b=[],c=this.getRanges(),d=0;d<c.length;d++)b.push(c[d].createBookmark2(a));return b},createBookmarks:function(a,b){for(var c=[],d=this.document,i,b=b||this.getRanges(),k=b.length,m=0;m<k;m++){c.push(i=b[m].createBookmark(a,r));var n=(a=i.serializable)?h.one("#"+i.startNode,d):i.startNode;i=a?h.one("#"+i.endNode,d):i.endNode;
for(var w=m+1;w<k;w++){var o=b[w],q=o.startContainer,p=o.endContainer;j.equals(q,n.parent())&&o.startOffset++;j.equals(q,i.parent())&&o.startOffset++;j.equals(p,n.parent())&&o.endOffset++;j.equals(p,i.parent())&&o.endOffset++}}return c},selectBookmarks:function(a){for(var b=[],c=0;c<a.length;c++){var d=new q(this.document);d.moveToBookmark(a[c]);b.push(d)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-
1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,!1)},removeAllRanges:function(){var a=this.getNative();o?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},i=x.whitespaces(r),w=/\ufeff|\u00a0/;q.prototype.select=q.prototype.select=!o?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==j.ELEMENT_NODE&&!a[0].childNodes.length&&a[0].appendChild(this.document.createTextNode(""));var b=this.document.createRange();b.setStart(a[0],
this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(r),b.setEnd(this.endContainer[0],this.endOffset);else throw c;}a=t(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var c=this.collapsed,e,d;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var h=this.startContainer[0].childNodes[this.startOffset];if(h.nodeType==j.ELEMENT_NODE){(new k(this.document)).selectElement(new n(h));
return}}(this.startContainer[0].nodeType==j.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType==j.ELEMENT_NODE&&this.endContainer.nodeName()in b)&&this.shrink(u.SHRINK_ELEMENT,r);var m=this.createBookmark(),h=m.startNode,o;c||(o=m.endNode);m=this.document.body.createTextRange();m.moveToElementText(h[0]);m.moveStart("character",1);if(o)a=this.document.body.createTextRange(),a.moveToElementText(o[0]),m.setEndPoint("EndToEnd",a),m.moveEnd("character",-1);else{for(e=h[0].nextSibling;e&&
!i(e);)e=e.nextSibling;e=!(e&&e.nodeValue&&e.nodeValue.match(w))&&(a||!h[0].previousSibling||h[0].previousSibling&&"br"==j.nodeName(h[0].previousSibling));d=new n(this.document.createElement("span"));d.html("&#65279;");d.insertBefore(h);e&&j.insertBefore(this.document.createTextNode("\ufeff"),h[0]||h)}this.setStartBefore(h);h._4e_remove();if(c){if(e?(m.moveStart("character",-1),m.select(),this.document.selection.clear()):m.select(),d)this.moveToPosition(d,u.POSITION_BEFORE_START),d._4e_remove()}else this.setEndBefore(o),
o._4e_remove(),m.select()};k.getSelection=t;return p.Selection=k},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(h,k){function t(a){function b(a,b){var c=e.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=n}return c}function c(){var a=e.selection.createRange();h&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&h.select();u.remove(e,"mouseup",c);u.remove(e,"mousemove",d);h=f=0}function d(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",h)?a.setEndPoint("StartToStart",h):a.setEndPoint("EndToEnd",h),a.select()}else c()}var f,g=a.get("window")[0],
e=a.get("document")[0],h;u.on(e,"mousedown contextmenu",function(a){var j=e.documentElement;if(a.target===j&&(f&&c(),!(j.scrollHeight>j.clientHeight)&&(f=1,h=b(a.pageX,a.pageY))))u.on(e,"mouseup",c),u.on(e,"mousemove",d),g.focus(),h.select()})}function p(a){function b(h){if(e){var f=a.getSelection(),j=f&&f.getType(),l=f&&c.selection;if(h&&l&&j==q.SELECTION_NONE&&!c.queryCommandEnabled("InsertImage"))setTimeout(function(){b(d)},50);else{var k;if(!l||!l.type||!("Control"!=l.type&&(k=l.createRange())&&
(k=k.parentElement())&&(k=k.nodeName)&&k.toLowerCase()in{input:1,textarea:1}))g=l&&f.getRanges()[0],a.checkSelectionChange()}}}var c=a.get("document")[0],h=new x(c.body),f=new x(c.documentElement);if(8>k.Utils.ieEngine)f.on("click",function(b){"html"===(new x(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var g,e,l=d;f.on("mousedown",function(){l=j});f.on("mouseup",function(){l=d});h.on("focusin",function(a){if("body"==(new x(a.target)).nodeName()&&g){try{l&&g.select()}catch(b){}g=
n}});h.on("focus",function(){e=d;b()});h.on("beforedeactivate",function(a){a.relatedTarget||(e=j,l=d)});h.on("mousedown",function(){e=j});h.on("mouseup",function(){e=d;setTimeout(function(){b(d)},0)});h.on("keydown",function(){e=j});h.on("keyup",function(){e=d;setTimeout(function(){b()},0)})}function r(a){var b=a.get("document")[0];u.on(b,"mouseup keyup",function(){a.checkSelectionChange()})}function c(a){function b(a){var b=k.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}function c(a){return f(a)&&
g(a)}var h=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,f=k.Walker.whitespaces(d),g=k.Walker.bookmark(j,d),e=function(a){return f(a)&&8!=a.nodeType};a.on("selectionChange",function(g){var f=g.path,n=new x(a.get("document")[0].body),g=(g=g.selection)&&g.getRanges()[0],q=f.blockLimit;if(m.gecko){var p=f.block||f.blockLimit,r=p&&p.last(c);p&&p._4e_isBlockBoundary()&&(!r||!(1==r[0].nodeType&&r._4e_isBlockBoundary()))&&
"pre"!=p.nodeName()&&!p._4e_getBogus()&&p._4e_appendBogus()}if(g&&g.collapsed&&!f.block){if("body"==q.nodeName()){if((f=g.fixBlock(d,"p"))&&f[0]!=n[0].lastChild&&f._4e_outerHtml().match(h))if((q=f.next(e,1))&&q[0].nodeType==o.ELEMENT_NODE&&!b[q])g.moveToElementEditablePosition(q),f._4e_remove();else if((q=f.prev(e,1))&&q[0].nodeType==o.ELEMENT_NODE&&!b[q])g.moveToElementEditablePosition(q,q._4e_outerHtml().match(h)?j:d),f._4e_remove();g.select();a.notifySelectionChange()}f=a.get("document")[0];g=
new k.Range(f);g.moveToElementEditablePosition(n,d);"body"!==(new k.ElementPath(g.startContainer)).blockLimit.nodeName()&&(n=(new x(f.createElement("p"))).appendTo(n),m.ie||n._4e_appendBogus())}})}var d=!0,j=!1,n=null,m=h.UA,u=h.Event,o=h.DOM,x=h.Node,q=k.SELECTION;return{init:function(a){a.docReady(function(){m.ie?(t(a),p(a)):r(a)});c(a)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(h,k){function t(a){return!y.attr(a,"_ke_bookmark")}function p(a,b){for(var c in a)a.hasOwnProperty(c)&&(h.isString(a[c])?a[c]=a[c].replace(R,function(a,c){return b[c]}):p(a[c],b))}function r(a,b){b&&(a=h.clone(a),p(a,b));var c=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type="#text"==c||H[c]?C.STYLE_BLOCK:O[c]?C.STYLE_OBJECT:C.STYLE_INLINE;this._={definition:a}}function c(a,b){var c=b?this.removeFromRange:this.applyToRange;a.body.focus();
for(var d=new F(a),e=d.getRanges(),g=0;g<e.length;g++)c.call(this,e[g]);d.selectRanges(e)}function d(a,b,c){var d=a.element;"*"==d&&(d="span");b=new s(b.createElement(d));c&&c._4e_copyAttributes(b);c=a._.definition;a=c.attributes;c=r.getStyleText(c);if(a)for(var e in a)a.hasOwnProperty(e)&&b.attr(e,a[e]);c&&(b[0].style.cssText=c);return b}function j(a){var b=a.createBookmark(l),c=a.createIterator();c.enforceRealBlocks=l;c.enlargeBr=l;for(var e,g=a.document;e=c.getNextParagraph();){var i=d(this,g,
e),f=i,i="pre"==f.nodeName,h="pre"==e.nodeName,j=!i&&h;i&&!h?(h=e,j=h.html(),j=n(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),N.ie?(h=h[0].ownerDocument.createElement("div"),h.appendChild(f[0]),f[0].outerHTML="<pre>"+j+"</pre>",f=new s(h.firstChild),f._4e_remove()):f.html(j)):j?f=u(m(e),f):e._4e_moveChildren(f);e[0].parentNode.replaceChild(f[0],e[0]);if(i&&(e=f,i=void 0,(i=e._4e_previousSourceNode(l,
y.ELEMENT_NODE))&&"pre"==i.nodeName()))f=n(i.html(),/\n$/,"")+"\n\n"+n(e.html(),/^\n/,""),N.ie?e[0].outerHTML="<pre>"+f+"</pre>":e.html(f),i._4e_remove()}a.moveToBookmark(b)}function n(a,b,c){var e="",d="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,c){b&&(e=b);c&&(d=c);return""});return e+a.replace(b,c)+d}function m(a){var b=[];n(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,c){return b+"</pre>"+
c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(a,c){b.push(c)});return b}function u(a,b){for(var c=b[0].ownerDocument.createDocumentFragment(),e=0;e<a.length;e++){var d=a[e],d=d.replace(/(\r\n|\r)/g,"\n"),d=n(d,/^[ \t]*\n/,""),d=n(d,/\n$/,""),d=n(d,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),d=d.replace(/\n/g,"<br>"),d=d.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),
g=b.clone();g.html(d);c.appendChild(g[0])}return c}function o(a){var b=a.document;if(a.collapsed)b=d(this,b,void 0),a.insertNode(b),a.moveToPosition(b,G.POSITION_BEFORE_END);else{var c=this.element,e=this._.definition,g,i=L[c];i||(g=l,i=L.span);var h=a.createBookmark();a.enlarge(G.ENLARGE_ELEMENT);a.trim();for(var j=a.createBookmark(),k=j.startNode,j=j.endNode,m=k,D;m&&m[0];){var n=v;if(y.equals(m,j))m=z,n=l;else{var o=m[0].nodeType,q=o==y.ELEMENT_NODE?m.nodeName():z;if(q&&m.attr("_ke_bookmark")){m=
m._4e_nextSourceNode(l);continue}if(!q||i[q]&&(m._4e_position(j)|A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(m))){var p=m.parent();if(p&&"a"==c&&p.nodeName()==c)o=d(this,b,void 0),p._4e_moveChildren(o),p[0].parentNode.replaceChild(o[0],p[0]),o._4e_mergeSiblings();else if(p&&p[0]&&((L[p.nodeName()]||L.span)[c]||g)&&(!e.parentRule||e.parentRule(p))){if(!D&&(!q||!L.$removeEmpty[q]||(m._4e_position(j)|
A.POSITION_PRECEDING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_PRECEDING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED))D=new J(b),D.setStartBefore(m);if(o==y.TEXT_NODE||o==y.ELEMENT_NODE&&!m[0].childNodes.length){p=m;for(o=null;(n=!p.next(t,1))&&(o=p.parent())&&i[o.nodeName()]&&(o._4e_position(k)|A.POSITION_FOLLOWING|A.POSITION_IDENTICAL|A.POSITION_IS_CONTAINED)==A.POSITION_FOLLOWING+A.POSITION_IDENTICAL+A.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(o));)p=o;D.setEndAfter(p)}}else n=
l}else n=l;m=m._4e_nextSourceNode()}if(n&&D&&!D.collapsed){for(var n=d(this,b,void 0),p=D.getCommonAncestor(),o={},q={},H,r=null,w;n&&p&&n[0]&&p[0];){if(p.nodeName()==c){for(H in e.attributes)if(e.attributes.hasOwnProperty(H)&&!q[H]&&(w=p.attr(r)))n.attr(H)==w?n.removeAttr(H):q[H]=1;for(r in e.styles)if(e.styles.hasOwnProperty(r)&&!o[r]&&(w=p.style(r)))n.style(r)==w?n.style(r,""):o[r]=1;if(!n._4e_hasAttributes()){n=z;break}}p=p.parent()}n?(n[0].appendChild(D.extractContents()),f(this,n),D.insertNode(n),
n._4e_mergeSiblings(),N.ie||n[0].normalize()):(n=new s(b.createElement("span")),n[0].appendChild(D.extractContents()),D.insertNode(n),f(this,n),n._4e_remove(!0));D=z}}k._4e_remove();j._4e_remove();a.moveToBookmark(h);a.shrink(G.SHRINK_TEXT)}}function x(a){a.enlarge(G.ENLARGE_ELEMENT);var c=a.createBookmark(),e=c.startNode;if(a.collapsed){for(var d=new D(e.parent()),f,h=0,j;h<d.elements.length&&(j=d.elements[h])&&!(j==d.block||j==d.blockLimit);h++)if(this.checkElementRemovable(j)){var k=a.checkBoundaryOfElement(j,
G.END),l=!k&&a.checkBoundaryOfElement(j,G.START);l||k?(f=j,f.match=l?"start":"end"):(j._4e_mergeSiblings(),j.nodeName()!=this.element?(k=b(this),g(j,k[j.nodeName()]||k["*"])):i(this,j))}if(f){j=e;for(h=0;;h++){k=d.elements[h];if(y.equals(k,f))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(j[0]);j=k}j["start"==f.match?"insertBefore":"insertAfter"](f)}}else{var m=c.endNode,n=this,d=function(){for(var a=new D(e.parent()),b=new D(m.parent()),c=z,d=z,g=0;g<a.elements.length;g++){var i=
a.elements[g];if(i==a.block||i==a.blockLimit)break;n.checkElementRemovable(i)&&(c=i)}for(g=0;g<b.elements.length;g++){i=b.elements[g];if(i==b.block||i==b.blockLimit)break;n.checkElementRemovable(i)&&(d=i)}d&&m._4e_breakParent(d);c&&e._4e_breakParent(c)};d();for(f=new s(e[0].nextSibling);f[0]!==m[0];){h=f._4e_nextSourceNode();if(f[0]&&f[0].nodeType==y.ELEMENT_NODE&&this.checkElementRemovable(f)&&(f.nodeName()==this.element?i(this,f):(j=b(this),g(f,j[f.nodeName()]||j["*"])),h[0].nodeType==y.ELEMENT_NODE&&
h.contains(e)))d(),h=new s(e[0].nextSibling);f=h}}a.moveToBookmark(c)}function q(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,e){b[c]=e});return b}function a(a,b){var c="";b!==v?(c=document.createElement("span"),c.style.cssText=a,c=c.style.cssText||""):c=a;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function b(a){if(a._.overrides)return a._.overrides;var b=a._.overrides={},c=a._.definition.overrides;
if(c){h.isArray(c)||(c=[c]);for(var e=0;e<c.length;e++){var d=c[e],g,i,f;"string"==typeof d?g=d.toLowerCase():(g=d.element?d.element.toLowerCase():a.element,i=d.attributes,f=d.styles);d=b[g]||(b[g]={});if(i){g=d.attributes=d.attributes||[];for(var j in i)i.hasOwnProperty(j)&&g.push([j.toLowerCase(),i[j]])}if(f){var d=d.styles=d.styles||[],s;for(s in f)f.hasOwnProperty(s)&&d.push([s.toLowerCase(),f[s]])}}}return b}function i(a,c){var d=a._.definition,g=b(a),i=h.merge(d.attributes,(g[c.nodeName()]||
g["*"]||{}).attributes),d=h.merge(d.styles,(g[c.nodeName()]||g["*"]||{}).styles),g=h.isEmptyObject(i)&&h.isEmptyObject(d),f;for(f in i)if(i.hasOwnProperty(f)&&!(("class"==f||a._.definition.fullMatch)&&c.attr(f)!=w(f,i[f])))g=g||!!c.hasAttr(f),c.removeAttr(f);for(var s in d)d.hasOwnProperty(s)&&!(a._.definition.fullMatch&&c.style(s)!=w(s,d[s],l))&&(g=g||!!c.style(s),c.style(s,""));e(c)}function w(a,b,c){var d=new s("<span>");d[c?"style":"attr"](a,b);return d[c?"style":"attr"](a)}function f(a,c){for(var d=
b(a),e=c.all(a.element),f=e.length;0<=--f;)i(a,new s(e[f]));for(var h in d)if(d.hasOwnProperty(h)&&h!=a.element){e=c.all(h);for(f=e.length-1;0<=f;f--){var j=new s(e[f]);g(j,d[h])}}}function g(a,b){var c,d=b&&b.attributes;if(d)for(c=0;c<d.length;c++){var g=d[c][0],i;if(i=a.attr(g)){var f=d[c][1];(f===z||f.test&&f.test(i)||"string"==typeof f&&i==f)&&a[0].removeAttribute(g)}}if(d=b&&b.styles)for(c=0;c<d.length;c++)if(g=d[c][0],f=a.css(g)){var h=d[c][1];(h===z||h.test&&h.test(i)||"string"==typeof h&&
f==h)&&a.css(g,"")}e(a)}function e(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,c=a[0].lastChild;a._4e_remove(l);b&&(b.nodeType==y.ELEMENT_NODE&&y._4e_mergeSiblings(b),c&&b!=c&&c.nodeType==y.ELEMENT_NODE&&y._4e_mergeSiblings(c))}}var l=!0,v=!1,z=null,y=h.DOM,C={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},G=k.RANGE,F=k.Selection,A=k.POSITION,J=k.Range,s=h.Node,N=h.UA,D=k.ElementPath,H={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},L=k.XHTML_DTD,O={embed:1,hr:1,img:1,li:1,object:1,
ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},P=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;k.STYLE=C;r.prototype={apply:function(a){c.call(this,a,v)},remove:function(a){c.call(this,a,l)},applyToRange:function(a){return(this.applyToRange=this.type==C.STYLE_INLINE?o:this.type==C.STYLE_BLOCK?j:z).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==C.STYLE_INLINE?x:z).call(this,a)},checkElementRemovable:function(c,d){if(!c)return v;var e=this._.definition,g;if(c.nodeName()==
this.element){if(!d&&!c._4e_hasAttributes())return l;var f=e._AC;if(f)e=f;else{var f={},i=0,h=e.attributes;if(h)for(var s in h)h.hasOwnProperty(s)&&(i++,f[s]=h[s]);if(h=r.getStyleText(e))f.style||i++,f.style=h;f._length=i;e=e._AC=f}if(e._length){for(var j in e)if("_length"!=j&&e.hasOwnProperty(j)){i=c.attr(j)||"";if("style"==j)a:{f=e[j];i=a(i,v);"string"==typeof f&&(f=q(f));"string"==typeof i&&(i=q(i));h=void 0;for(h in f)if(f.hasOwnProperty(h)&&!(h in i&&(i[h]==f[h]||"inherit"==f[h]||"inherit"==
i[h]))){f=v;break a}f=l}else f=e[j]==i;if(f){if(!d)return l}else if(d)return v}if(d)return l}else return l}j=b(this);if(j=j[c.nodeName()]||j["*"]){if(!(e=j.attributes)&&!(g=j.styles))return l;if(e)for(f=0;f<e.length;f++)if(j=e[f][0],j=c.attr(j))if(i=e[f][1],i===z||"string"==typeof i&&j==i||i.test&&i.test(j))return l;if(g)for(f=0;f<g.length;f++)if(j=c.css(g[f][0]))if(e=g[f][1],e===z||"string"==typeof e&&j==e||e.test&&e.test(j))return l}return v},checkActive:function(a){switch(this.type){case C.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,l);case C.STYLE_OBJECT:case C.STYLE_INLINE:for(var b=a.elements,c=0,d;c<b.length;c++)if(d=b[c],!(this.type==C.STYLE_INLINE&&(y.equals(d,a.block)||y.equals(d,a.blockLimit))))if((this.type!=C.STYLE_OBJECT||d.nodeName()in O)&&this.checkElementRemovable(d,l))return l}return v}};r.getStyleText=function(b){var c=b._ST;if(c)return c;var c=b.styles,d=b.attributes&&b.attributes.style||"",e="";d.length&&(d=d.replace(P,";"));for(var f in c)if(c.hasOwnProperty(f)){var i=c[f],g=(f+":"+i).replace(P,
";");"inherit"==i?e+=g:d+=g}d.length&&(d=a(d));return b._ST=d+e};return k.Style=r},{requires:["./base","./range","./selection","./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(h){var k=h.Node,t=h.DOM,p=h.UA,r={debugUrl:function(c){var d=h.Config;d.debug||(c=c.replace(/\.(js|css)/i,"-min.$1"));-1==c.indexOf("?t")&&(c=-1!=c.indexOf("?")?c+"&":c+"?",c+="t="+encodeURIComponent(d.tag));return d.base+"editor/"+c},lazyRun:function(c,d,h){var k=c[d],m=c[h];c[d]=function(){k.apply(this,arguments);c[d]=c[h];return m.apply(this,arguments)}},getXY:function(c,d){var h=c.left,k=c.top,m=d.get("window")[0],h=h-t.scrollLeft(m),k=k-t.scrollTop(m),m=
d.get("iframe").offset(),h=h+m.left,k=k+m.top;return{left:h,top:k}},tryThese:function(c){for(var d,h=0,k=arguments.length;h<k;h++){var m=arguments[h];try{d=m();break}catch(p){}}return d},arrayCompare:function(c,d){if(!c&&!d)return!0;if(!c||!d||c.length!=d.length)return!1;for(var h=0;h<c.length;h++)if(c[h]!==d[h])return!1;return!0},clearAllMarkers:function(c){for(var d in c)c.hasOwnProperty(d)&&c[d]._4e_clearMarkers(c,!0,void 0)},ltrim:function(c){return c.replace(/^\s+/,"")},rtrim:function(c){return c.replace(/\s+$/,
"")},isNumber:function(c){return/^\d+(.\d+)?$/.test(h.trim(c))},verifyInputs:function(c){for(var d=0;d<c.length;d++){var j=new k(c[d]),n=h.trim(r.valInput(j)),m=j.attr("data-verify"),j=j.attr("data-warning");if(m&&!RegExp(m).test(n))return alert(j),!1}return!0},sourceDisable:function(c,d){c.on("sourceMode",d.disable,d);c.on("wysiwygMode",d.enable,d)},resetInput:function(c){var d=c.attr("placeholder");d&&p.ie?(c.addClass("ks-editor-input-tip"),c.val(d)):p.ie||c.val("")},valInput:function(c,d){if(void 0===
d)return c.hasClass("ks-editor-input-tip")?"":c.val();c.removeClass("ks-editor-input-tip");c.val(d)},placeholder:function(c,d){c.attr("placeholder",d);p.ie&&(c.on("blur",function(){h.trim(c.val())||(c.addClass("ks-editor-input-tip"),c.val(d))}),c.on("focus",function(){c.removeClass("ks-editor-input-tip");h.trim(c.val())==d&&c.val("")}))},htmlEncode:function(c){return!c?c:(""+c).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(c){var c=h.clone(c),
d;for(d in c)if(c.hasOwnProperty(d)){var j=c[d];h.isFunction(j)&&(c[d]=j())}return c},map:function(c,d){for(var h=0;h<c.length;h++)c[h]=d(c[h]);return c},ieEngine:document.documentMode||p.ie,preventFocus:function(c){p.ie?c.unselectable(void 0):c.attr("onmousedown","return false;")},injectDom:function(c){h.mix(t,c);for(var d in c)c.hasOwnProperty(d)&&function(d){k.prototype[d]=function(){var n=[].slice.call(arguments,0);n.unshift(this[0]);return(n=c[d].apply(null,n))&&(n.nodeType||h.isWindow(n))?new k(n):
h.isArray(n)&&(n.__IS_NODELIST||n[0]&&n[0].nodeType)?new k(n):n}}(d)},addRes:function(){var c=this.__res=this.__res||[];c.push.apply(c,h.makeArray(arguments))},destroyRes:function(){for(var c=this.__res||[],d=0;d<c.length;d++){var j=c[d];h.isFunction(j)?j():j.destroy?j.destroy():j.remove&&j.remove()}this.__res=[]},getQueryCmd:function(c){return"query"+("-"+c).replace(/-(\w)/g,function(c,h){return h.toUpperCase()})+"Value"}};return h.Editor.Utils=r},{requires:["./base"]});
KISSY.add("editor/core/walker",function(h,k){function t(a,b){if(this._.end)return j;var f,g=this.range,e,h=this.guard,k=this.type,n=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,g.trim(),g.collapsed))return this.end(),j;if(!a&&!this._.guardLTR){var p=g.endContainer[0],q=p.childNodes[g.endOffset];this._.guardLTR=function(a,b){return b&&(p==a||"body"==m.nodeName(a))?!1:a!=q}}if(a&&!this._.guardRTL){var r=g.startContainer[0],t=0<g.startOffset&&r.childNodes[g.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(r==a||"body"==m.nodeName(a))?!1:a!=t}}var u=a?this._.guardRTL:this._.guardLTR;e=h?function(a,b){return u(a,b)===d?d:h(a,b)}:u;this.current?f=this.current[n](d,k,e):a?(f=g.endContainer,0<g.endOffset?(f=new o(f[0].childNodes[g.endOffset-1]),e(f[0])===d&&(f=j)):f=e(f,c)===d?j:f._4e_previousSourceNode(c,k,e,void 0)):(f=g.startContainer,f=new o(f[0].childNodes[g.startOffset]),f.length?e(f[0])===d&&(f=j):f=e(g.startContainer,c)===d?j:g.startContainer._4e_nextSourceNode(c,
k,e,void 0));for(;f&&!this._.end;){this.current=f;if(!this.evaluator||this.evaluator(f[0])!==d){if(!b)return f}else if(b&&this.evaluator)return d;f=f[n](d,k,e)}this.end();return this.current=j}function p(a){for(var b,c=j;b=t.call(this,a);)c=b;return c}function r(a){this.range=a;this.guard=this.evaluator=j;this._={}}var c=!0,d=!1,j=null,n=h.UA,m=h.DOM,u=k.XHTML_DTD,o=h.Node;h.augment(r,{end:function(){this._.end=1},next:function(){return t.call(this)},previous:function(){return t.call(this,c)},checkForward:function(){return t.call(this,
d,c)!==d},checkBackward:function(){return t.call(this,c,c)!==d},lastForward:function(){return p.call(this)},lastBackward:function(){return p.call(this,c)},reset:function(){delete this.current;this._={}},_iterator:t});h.mix(r,{blockBoundary:function(a){return function(b){return!(b.nodeType==m.ELEMENT_NODE&&m._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(a){return"span"==m.nodeName(a)&&m.attr(a,"_ke_bookmark")}return function(d){var e,h;e=d.nodeType==m.TEXT_NODE&&(h=d.parentNode)&&c(h);
e=a?e:e||c(d);return!!(b^e)}},whitespaces:function(a){return function(b){b=b.nodeType==m.TEXT_NODE&&!h.trim(b.nodeValue);return!!(a^b)}},invisible:function(a){var b=r.whitespaces();return function(c){c=b(c)||c.nodeType==m.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var x=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,q=r.whitespaces(),a=r.bookmark(),b=function(b){var c=m.nodeName(b);return a(b)||q(b)||1==b.nodeType&&c in u.$inline&&!(c in u.$empty)};k.Utils.injectDom({_4e_getBogus:function(a){a=new o(a);do a=
a._4e_previousSourceNode();while(a&&b(a[0]));a=a&&(!n.ie?"br"==a.nodeName():3==a[0].nodeType&&x.test(a.text()))?a[0]:!1;return a}});return k.Walker=r},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(h){var k=h.Editor,h=k.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};k.baseZIndex=function(h){return(k.Config.baseZIndex||1E4)+h};return h},{requires:["./base"]});
KISSY.add("editor",function(h,k,t,p,r,c,d,j,n,m){function u(a,c){var d=a.body;C(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){a.designMode="off";v.attr(d,"contentEditable",f);v.attr(d,"contentEditable",b);!c&&u(a,1)})}function o(a){a.get("iframe");var b=a.get("textarea")[0],c=a.get("window")[0],d=a.get("document")[0];e.webkit&&(y.on(d,"click",function(a){var b=new z(a.target);h.inArray(b.nodeName(),
["input","select"])&&a.preventDefault()}),y.on(d,"mouseup",function(a){var b=new z(a.target);h.inArray(b.nodeName(),["input","textarea"])&&a.preventDefault()}));if(e.gecko||l||e.opera){var g;g=(new z('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(b);g.on("focus",function(){a.focus()});a.activateGecko=function(){e.gecko&&a.__iframeFocus&&g[0].focus()};a.on("destroy",function(){g.detach();g.remove()})}y.on(c,"focus",function(){e.gecko?u(d,f):e.opera&&
d.body.focus();a.notifySelectionChange()});if(e.gecko)y.on(d,"mousedown",function(){a.__iframeFocus||u(d,f)});if(l&&(y.on(d,"keydown",function(b){if(b.keyCode in{8:1,46:1}){var c=a.getSelection(),d=c.getSelectedElement();if(d){a.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);a.execCommand("save");b.preventDefault()}}}),"CSS1Compat"==d.compatMode)){var i={33:1,34:1};y.on(d,"keydown",function(b){b.keyCode in i&&setTimeout(function(){a.getSelection().scrollIntoView()},
0)})}if(e.webkit)y.on(d,"mousedown",function(b){b=new z(b.target);h.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&a.getSelection().selectElement(b)});if(e.gecko)y.on(d,"dragstart",function(a){var b=new z(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});p.add(a)}function x(a,b,c,d){var e="",f,i=t.debugUrl("theme/editor-iframe.css");for(f=0;f<c.length;f++)e+=h.substitute('<link href="{href}" rel="stylesheet" />',{href:c[f]});return h.substitute(G,{doctype:8===
g.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:i,style:b,data:d||"&nbsp;",script:a?'<script id="ke_active_script">'+(v.isCustomDomain()?'document.domain="'+g.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+a+'");<\/script>':""})}function q(a,b){function c(){h=g.document;a.__set("document",new z(h));a.__set("window",new z(g));d.detach();h.open("text/html","replace");h.write(e);h.close()}var d=a.get("iframe"),e=x(a._UUID,a.get("customStyle"),a.get("customLink"),
b),f=d[0],g=f.contentWindow,h;d.__loaded=1;try{h=g.document}catch(i){if(f.src=f.src,7>l){setTimeout(c,10);return}}c()}function a(a,b){var c=v.getEmptyIframeSrc()||"";c&&(c=' src="'+c+'" ');var c=new z(h.substitute(F,{iframeSrc:c})),d=a.get("textarea");d.hasAttr("tabindex")&&c.attr("tabIndex",e.webkit?-1:d.attr("tabIndex"));d.parent().prepend(c);a.set("iframe",c);a.__docReady=0;if(e.gecko&&!c.__loaded)c.on("load",function(){q(a,b)},a);else q(a,b)}var b=!0,i=i,w=h.all,f=!1,g=document,e=h.UA,l=e.ie,
v=h.DOM,z=h.Node,y=h.Event,C=t.tryThese,G="<!doctype html><html><head>{doctype}<title>{title}</title><link href='{href}' rel='stylesheet' /><style>{style}</style>{links}</head><body class='ks-editor'>{data}{script}</body></html>",F='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>';h.mix(k,{SOURCE_MODE:0,WYSIWYG_MODE:1});var A=k.WYSIWYG_MODE;h.augment(k,{createDom:function(){var a,b=this.get("textarea"),c;
b||this.set("textarea",b=w("<textarea class='ks-editor-textarea'></textarea>"));c=this.get("el");c.html('<div class="ks-editor-tools"></div><div class="ks-editor-textarea-wrap"></div><div class=\'ks-editor-status\'></div>');a=c.one(".ks-editor-textarea-wrap");this._UUID=h.guid();this.set({toolBarEl:c.one(".ks-editor-tools"),statusBarEl:c.one(".ks-editor-status")},{silent:1});b.css("width","100%");b.css("display","none");a.append(b);p.register(this)},renderUI:function(){d.init(this);j.init(this);n.init(this);
m.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,c,d=b.get("prefixCls"),e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form))v.on(c,"submit",b.sync,b),b.on("destroy",function(){v.detach(c,"submit",b.sync,b)});b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},_uiSetHeight:function(a){var b=
this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||0));b.parent().css("height",a);b.css("height",a)},_uiSetMode:function(a){var b=this,c,d=b.get("rendered"),e=b.get("iframe"),f=b.get("textarea");a==A?(d&&b.execCommand("save"),b.on("docReady",c=function(){d&&b.execCommand("save");b.detach("docReady",c)}),b._setData(f.val()),b.fire("wysiwygMode")):(e&&(f.val(b._getData(1,A)),e.hide()),f.show(),b.fire("sourceMode"))},
_uiSetFocused:function(a){a&&this.__docReady&&this.focus()},destructor:function(){var a=this.get("document")[0],b=this.get("window");this.sync();p.remove(this);y.remove([a,a.documentElement,a.body,b[0]]);h.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];
c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(a){var b=this.__commands[a],c=h.makeArray(arguments);c.shift();c.unshift(this);if(b)return b.exec.apply(b,c)},queryCommandValue:function(a){return this.execCommand(t.getQueryCmd(a))},_getData:function(a,b){var c=this.htmlDataProcessor,d;b==i&&(b=this.get("mode"));d=b==A?this.get("document")[0].body.innerHTML:
c.toDataFormat(this.get("textarea").val());d=a?c.toHtml(d):c.toServer(d);d=h.trim(d);/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/.test(d)&&(d="");return d},_setData:function(b){var c,d=b;if(this.get("mode")!=A)this.get("textarea").val(b);else{if(c=this.htmlDataProcessor)d=c.toDataFormat(b);if(this.get("iframe")){b=this.get("iframe");c=this.get("window")[0];var e=this.get("document")[0];y.remove([e,e.documentElement,e.body,c]);b.remove()}a(this,d)}},sync:function(){this.get("textarea").val(this.get("data"))},
getDocHtml:function(){return x(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getSelection:function(){return k.Selection.getSelection(this.get("document")[0])},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];e.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("customStyle")||
"",c=c+("\n"+a);this.set("customStyle",c);v.addStyleSheet(this.get("window"),c,b)},removeCustomStyle:function(a){v.remove(v.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink")||[],c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(a){for(var b=this.get("document")[0],b=v.query("link",b),c=0;c<b.length;c++)v.attr(b[c],"href")==
a&&v.remove(b[c]);b=this.get("customLink")||[];a=h.indexOf(a,b);-1!=a&&b.splice(a,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),d=new k.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",
{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(this.get("mode")===A){this.focus();var c,d=a.nodeName(),e=k.XHTML_DTD,f=e.$block[d],g=k.RANGE,h=(d=this.getSelection())&&d.getRanges(),j,m,l;if(h&&0!=h.length){this.execCommand("save");for(m=h.length-1;0<=m;m--)j=h[m],c=!m&&a||a.clone(b),j.insertNodeByDtd(c),l||(l=c);if(l)return j.moveToPosition(l,g.POSITION_AFTER_END),f&&(a=k.Walker.whitespaces(!0),
(a=(l=l.next(a,1))&&l[0].nodeType==v.ELEMENT_NODE&&l.nodeName())&&e.$block[a]&&e[a]["#text"]&&j.moveToElementEditablePosition(l)),d.selectRanges([j]),this.focus(),c&&1==c[0].nodeType&&c.scrollIntoView(i,!1),J.call(this),c}}},insertHtml:function(a,b){var c=this,d,e=c.get("document")[0];if(c.get("mode")===A){if(d=c.htmlDataProcessor)a=d.toDataFormat(a,b);c.focus();c.execCommand("save");if(l){d=e.selection;"Control"==d.type&&d.clear();try{d.createRange().pasteHTML(a)}catch(g){}}else try{e.execCommand("inserthtml",
f,a)}catch(h){setTimeout(function(){if(0==c.getSelection().getRanges().length){var b=new k.Range(e),d=v.first(e.body,function(a){return 1==a.nodeType&&"br"!=v.nodeName(a)});d||(d=new z(e.createElement("p")),d._4e_appendBogus(i),e.body.appendChild(d[0]));b.setStartAt(d,k.RANGE.POSITION_AFTER_START);b.select()}e.execCommand("inserthtml",f,a)},50)}setTimeout(function(){c.getSelection().scrollIntoView()},50);J.call(c)}}});k._initIFrame=function(a){var c=p.getInstance(a),d=c.get("document")[0],a=d.getElementById("ke_active_script");
v.remove(a);o(c);var g=d.body;l?(g.hideFocus=b,g.disabled=b,g.contentEditable=b,g.removeAttribute("disabled")):setTimeout(function(){e.gecko||e.opera?g.contentEditable=b:e.webkit?g.parentNode.contentEditable=b:d.designMode="on"},0);if(e.gecko||e.opera){var h=d.documentElement;y.on(h,"mousedown",function(a){if(a.target==h){e.gecko&&u(d,f);c.activateGecko()}})}setTimeout(function(){l&&setTimeout(function(){if(d){g.runtimeStyle.marginBottom="0px";g.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=
1;c.fire("docReady");var a=c.get("disableObjectResizing"),b=c.get("disableInlineTableEditing");if(a||b)try{d.execCommand("enableObjectResizing",f,!a);d.execCommand("enableInlineTableEditing",f,!b)}catch(e){y.on(g,l?"resizestart":"resize",function(c){var d=new z(c.target);(a||d.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};var J=h.buffer(function(){this.execCommand("save")},50);return k},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
